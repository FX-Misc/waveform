<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="managed-canvas">
<template>
    
</template>
<script>
"use strict";

Polymer({
    is:'managed-canvas',
    properties: {
        ckey: {
            type: String,
            value: "",
            observer: '_update'
        },
        fix_height: {
            type: Number,
            value: 0,
            observer: '_height_changed'
        },
        stretch_height: {
            type: Boolean,
            value: false,
            observer: '_height_changed'
        }
    }, listeners: {
        'mousemove': '_onmousemove',
        'mousedown': '_onmousedown',
        'mouseup': '_onmouseup',
        'iron-resize': '_height_changed'
    }, _update: function(){
        var old = Polymer.dom(this.root).firstChild;
        if(old){
            Polymer.dom(this.root).removeChild(old);
        }
        if(Utils.canvas_manager && this.ckey){
            let el_canv = this.ckey.canvas;
            el_canv && this._update_canv_style(el_canv);
            Polymer.dom(this.root).appendChild(el_canv);
        }
    }, _height_changed: function(){
        if(!this.ckey){
            return;
        }
        let el_canv = this.ckey.canvas;
        this._update_canv_style(el_canv);
    }, _update_canv_style: function(el_canv){
        if(this.fix_height && this.stretch_height){
            console.warn('managed-canvas cannot stretch and fix height')
        }
        if(el_canv){
            el_canv.style.cssText = "";
            if(this.stretch_height){
                // this does what is needed for now, but it's not pretty...
                el_canv.style.height = "100%";
                el_canv.style.margin = "0 auto";
                el_canv.style.left = "0";
                el_canv.style.right = "0";
                el_canv.style.position = "absolute";
            } else if (this.fix_height){
                el_canv.style.height = this.fix_height + "px";
            } else {
                el_canv.style.height = "";
            }
            el_canv.style.imageRendering = "pixelated";          
        }
    }, _onmousemove: function(e){
        this._fire_pointer_event(e, 'canvas-mousemove');
    }, _onmouseup: function(e){
        this._fire_pointer_event(e, 'canvas-mouseup');
    }, _onmousedown: function(e){
        this._fire_pointer_event(e, 'canvas-mousedown');
    }, _fire_pointer_event: function(e, name){
        // TODO: might be nice to cache the metrics rather than recomputing from scratch each time
        let canv_el = Polymer.dom(this.root).firstChild;
        if(!canv_el){
            return;
        }
        let rect = canv_el.getBoundingClientRect();
        e.offset_x = e.clientX-rect.left;
        e.offset_y = e.clientY-rect.top;
        e.canvas_width = rect.width;
        e.canvas_height = rect.height;
        e.canvas_point = [
            0 | (e.offset_y/rect.height*canv_el.height), 
            0 | (e.offset_x/rect.width*canv_el.width)
        ];
        this.fire(name, e);
    }
});

</script>
</dom-module>
