<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="marker-element">
<style type="text/css">
:host {
position: absolute;
top: 0px;
left: 0px;
height: 100%;
width: 100%;
overflow: hidden;
}
</style>
<template><svg></svg></template>
<script>
"use strict";

Polymer({
	is: 'marker-element',
	properties:{
		state: {
			type: Object, // has kind, x1, y1, x2, y2, label, and transform_func
			value: null,
			notify: true
		}
	},
	observers: [
		'_update_svg(state.*)'
	],
	_update_svg: function(){
		this.debounce('update', function(){
			let svg;
			if(!this.state){
				svg = ""; 
			} else if (this.state.kind === "line"){

			let r = 3;
			let p1 = this.state.transform_func(this.state.y1, this.state.x1);
			let p2 = this.state.transform_func(this.state.y2, this.state.x2);

			// text background from: http://stackoverflow.com/a/31013492/2399799

			svg = `<svg style='pointer-events:none;position:absolute;left:0px;top:0px;width:100%;height:100%;' xmlns='http://www.w3.org/2000/svg' version='1.1'>
						<defs>
							<filter x="-10%" y="0" width="120%" height="1" id="solid">
								<feFlood flood-color="black"/>
								<feComposite in="SourceGraphic"/>
							</filter>
						</defs>

						<line x1='${p1[1]}' y1='${p1[0]}' x2='${p2[1]}' y2='${p2[0]}' stroke='black' stroke-width='3'/>
						<line x1='${p1[1]}' y1='${p1[0]}' x2='${p2[1]}' y2='${p2[0]}' stroke='white' stroke-width='1'/>
						<circle cx='${p1[1]}' cy='${p1[0]}' r='${r}' stroke='black' stroke-width='2' fill='white'/>
					    <circle cx='${p2[1]}' cy='${p2[0]}' r='${r}' stroke='black' stroke-width='2' fill='white'/>
					    <text filter="url(#solid)" x='${p1[1]/2 + p2[1]/2}' y='${p1[0]/2 + p2[0]/2}' fill="white" style='font-size:11px'> ${this.state.label} </text>
					</svg>`;
			} else {
				throw "unrecognised marker kind: " + this.state.kind;
			}

			Polymer.dom(this.root).innerHTML = svg;
			Polymer.dom.flush();
		});
	}
});
</script>
</dom-module>