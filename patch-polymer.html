<script>

/*
 Overwrite the Collection.add and .initMap methods.

 Here we provide the option of using "intrusive" keys
 for objects..although it's not fully intrusive, because
 the non-intrusive version still exists and is used by 
 the Collection class itself.
 
 Objects with a ._pkey=null property will have it set to the
 key when inserted into the collection, and when the 
 collection is initialized.

 Note that if the object is in multiple collections only the
 first insertion will set the pkey, because after that the
 value will no longer be null.  It is up to the user to be
 aware of this and use it appropriately.

*/
Polymer.Collection.prototype.add = function(item) {
  var key = this.store.push(item) - 1;
  if (item && typeof item == 'object') {
    this.omap.set(item, key);
    item._pkey === null && (item._pkey = '#' + key); // << this is extra
  } else {
    this.pmap[item] = key;
  }
  return '#' + key;
}

Polymer.Collection.prototype.initMap = function() {
  var omap = this.omap = new WeakMap();
  var pmap = this.pmap = {};
  var s = this.store;
  for (var i=0; i<s.length; i++) {
    var item = s[i];
    if (item && typeof item == 'object') {
      omap.set(item, i);
      item._pkey === null && (item._pkey = '#' + i); // << this is extra
    } else {
      pmap[item] = i;
    }
  }
}


Polymer.Base._addFeature({
  /*
    This is an important hack which allows you to avoid doing expensive
    notifications if you really have to.

    It is to be used when an object has various properties that will be
    rendered by only a single element.  The element registers itself as
    the primary view for the given object using

      this.setAsPrimaryViewForModel('special_object');

    where 'special_object' is the name of a property on the element.
    (I think this may support paths as well as raw property names, but
    I haven't tested it.)

    Then, in some other script we replace the following:

      this.notifyPath('some_array.#42.some_property', mutated_object.some_property)      

    with this:

       this.notifyPathForPrimaryView('some_property', mutated_object.some_property, mutated_object);

    Note how here we only use the final suffix for the path, and we provide the actual
    object as the final argument.
    (Again, I think you can use multi-part paths as the first argument, not just single property 
    names but I haven't tested it.)

    Using this approach very much goes against the Polymeric way of doing things, 
    but it's far easier to implement than something less hacky (I did try something
    much fancier, but ran in to all kinds of complciations and decided to abandon the effort.)
  */

  _primaryViews: new WeakMap(),

  setAsPrimaryViewForModel: function(model_name){
    let model = this.get(model_name);
    this._primaryViews.set(model, {
      el: this,
      prefix: model_name
    });
  },

  notifyPathForPrimaryView: function(path, value, model){
    let view = this._primaryViews.get(model);
    view && view.el.notifyPath(view.prefix + "." + path, value, true);
  }

});

</script>