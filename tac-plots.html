<!--
CUSTOM ELEMENT: tac-plots
BY: DM

This is designed to be used inside a tile-wall element.  The "groups" array of the tilewall should be bound
to this element's "groups" property.  Then whenever the tilewall's groups array is spliced this element will
be notified and can update ratemaps acordingly, with the tilewall be notified of the updates.

-->


<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="worker-builder.html">

<dom-module id="tac-plots">

<script is='worker-builder' id="worker" title="tac-plots" type='javascript/worker'>
"use strict";
var desired_max_delta_t;
var spike_times;

var set_max_delta_t = function(v){
    desired_max_delta_t = v;
}

var set_spike_times = function(arrays){
    spike_times = arrays.spike_times; // could be undefined
}

</script>

<template></template>


<script>
	"use strict";
    var worker_builder = Polymer.DomModule.import('tac-plots','#worker');

    Polymer({
    	is:'tac-plots',
    	properties: {
			max_delta_t: {
				type: Number,
				value: 2
			},
            spike_times: {
                type: String, // typed-array-manager id
                value: ""
            },
			groups: {
    			type: Array,
    			value: function(){return [];},
    			notify: true
    		}
    	},
    	observers: [
    		'groups_modified(groups.*)', 
            'options_modified(max_delta_t)',
            'times_modified(spike_times)'
    	],
        attached: function(){
            this.worker = worker_builder.create_for(this);
            this.worker.exec('set_max_delta_t', this.max_delta_t);
        },
    	groups_modified: function(change){
    		console.log(JSON.stringify(change))
            if(!this.worker) return;
            
    		if(!change)	return;
            var m = window.canvas_manager;
            
            change.indexSplices && change.indexSplices.forEach(function(s){
    			s.removed.forEach(function(group){
    				if(group.tac)
	    				m.free_canvas(group.tac);
    			}, this);

    			for(var ii=s.index, stop = s.index+s.addedCount; ii<stop; ii++){
    				var group = this.groups[ii];

    				// TODO: actually do this properly...
                    // this.worker.set_group_inds()
    				group.tac = m.create_from_dims([128,30]);
    			}
    		}, this);
    	},
        options_modified: function(){
            if(!this.worker) return;
            this.worker.exec('set_max_delta_t', this.max_delta_t);
        },
        times_modified: function(){
            if(this.spike_times){
                var arr = window.typed_array_manager.get_array_clone(this.spike_times);
                this.worker.exec_b('set_spike_times', {spike_times: arr});
            } else {
                if(!this.worker) return;
                this.worker.exec('set_spike_times', {});
            }
        }
	});
</script>

  
</dom-module>