<!--
CUSTOM ELEMENT: typed-array-manager
BY: DM

Polymer bindings don't work with typed arrays, so if you want to use them you need something more complicated.
This is similar to canvas-manager, though there is no managed-array element here (c.g. managed-canvas).

Create at least one instance of the element and then you can access the singleton at window.typed_array_manager.

TODO: it might be worth implementing this as a wrapper around a WeakMap, where the keys are (have to be) objects
rather than strings.  This would mean we don't have to worry about garbage collection and memory leaks...although
it makes it harder for the main thread to communicate with workers unless it maintains a basic version of the map,
using normal keys...and then you would need to do manual garbage collection again...so maybe it's not worth it.

-->


<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module akey="typed-array-manager">
<template>
</template>
<script>

"use strict";

(function(){

    var arrays = {};
    var last_akey = 0;
    var suffix = " (ta-manager)"; // can drop suffix using parseInt
    var validate_akey = function(akey){
        if((akey + "").indexOf(suffix) === -1)
            throw "typed-array-manager was passed invalid akey";
        return true;
    }

    Polymer({
        is:'typed-array-manager',
        properties: {},
        observers: [],
        created: function() {
            if (!window.typed_array_manager)
                window.typed_array_manager = this;
            // note that we don't use "this" anywhere else, because all the state is kept 
            // using the closure, not using the polymer element.  This means we have a singleton.
        },
        store_array: function(arr){
            arrays[++last_akey] = arr;
            return last_akey + suffix;
        },
        get_array: function(akey){
            return validate_akey(akey) && arrays[parseInt(akey)];
        },
        get_array_clone: function(akey){
            // note that the clone is not put in the store. It is
            // inteded to be used when dealing with workers, and needing to 
            // transfer an array in its intereity to another thread.
            var a = this.get_array(akey);
            return a && new a.constructor(a);
        },
        free_array: function(akey){
            validate_akey(akey);
            delete arrays[parseInt(akey)];
        }
    });

})();
</script>

  
</dom-module>