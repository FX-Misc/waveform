<script>

var Utils = {}

Utils.dedupe = function(splices){
	/* takes an array the form: 
	   [{added: ['a','b','c','d'], removed: ['e','f','g]}, 
	    {added: ...} , ...]
	 and "dedupes" it to a single pair of added and removed arrays,
	 such that any items which were added and removed multiple times
	 end up in the correct one of the two lists (or are ommited entirely).

	 Taken/adapted from dom-repeat._applySplicesUserSort.
	*/
	if (splices.length === 1){
		// assume that if there's only one element in the array then it's already properly de-deduped
		return splices[0]; 
	} else if(splices.length === 0){
		return {added: [], removed: []}; // TODO: check if this can happen
	}

	var key_map = {}; // -1: removed; +1: added; 0: neither added nor removed
	var key;

	for (var i=0, s; (i<splices.length) && (s=splices[i]); i++) {
		for (var j=0; j<s.removed.length; j++) {
			key = s.removed[j];
			key_map[key] = key_map[key] ? 0 : -1;
		}
		for (j=0; j<s.added.length; j++) {
			key = s.added[j];
			key_map[key] = key_map[key] ? 0 : 1;
		}
	}

	var removed = [];
	var added = [];
	for(key in key_map){
		if(key_map[key] == -1){
			removed.push(key);
		}else if(key_map[key] == +1){
			added.push(key);
		}
	}

	return {
		removed: removed,
		added: added
	};
	
}

utils.simple_clone = function(a){
	var b = {};
	for(aa in a){
		b[aa] = a[aa];
	}
	return b;
}
Utils.is_equal_simple = function(a, b){
    // very simple....
    if((a && !b) || (!a && b)){
        return false;
    }
    for(var aa in a){
        if(b[aa] !== a[aa]){
            return false;
        }
    }
    for(var bb in b){
        if(b[bb] !== a[bb]){
            return false;
        }
    }
    return true;
}


// setImmediate (on main thread), but we just the same impementation as worker-builder
// taken/adapted from https://github.com/YuzuJS/setImmediate/blob/master/setImmediate.js
(function(){
	// exports window.setImmediate and window.clearImmediate
	var last_task_h=0;
    var tasks = {};
    window._immediate_channel = new MessageChannel();
    _immediate_channel.port1.onmessage = function(e) {
        var h = e.data;
        try {
            tasks[h] && tasks[h]();
        } finally {
            clearImmediate(h);
        }
    }
    window.setImmediate = function(cb) {
        tasks[++last_task_h] = cb;
        _immediate_channel.port2.postMessage(last_task_h);
        return last_task_h;
    }
    window.clearImmediate = function(h){
        delete tasks[h];
    }
})();

</script>