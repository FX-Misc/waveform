<!--
CUSTOM ELEMENT: wave-plots
BY: DM

See tac-plots.html for introductorary notes.

-->


<link rel="import" href="bower_components/polymer/polymer.html">


<dom-module id="wave-plots">

<template></template>


<script>
	"use strict";
    Polymer({
    	is:'wave-plots',
    	properties: {
			palette_mode: {
				type: String,
				value: "density"
			},
			show_chans: {
				type: String,
				value: "yyyy"
			},
			groups: {
    			type: Array,
    			value: function(){return [];},
    			notify: true
    		}
    	},
    	observers: [
    		'_groups_set(groups)',
    		'_groups_spliced(groups.splices)'
    	],
    	created: function(){
    		this.key_to_canvas = {};
    		this.key_to_rendered_options = {};
    	},
    	_update_keys: function(keys_to_remove, keys_to_add){
            var am = window.typed_array_manager;
            var cm = window.canvas_manager;

            // get clones of new arrays to send to worker
            var added_arrays = {};
            for(var ii=0; ii<keys_to_add.length; ii++){
                var key = keys_to_add[ii];
                var taid = this.groups_collection.getItem(key).inds;
                added_arrays[key] = am.get_array_clone(taid);
            }

            // free canvases, it's our responsiblity to do this, whereas 
            // freeing the inds arrays was the responsibility of cut-obj.
            for(var ii=0; ii<keys_to_remove.length; ii++){
                var key = keys_to_remove[ii];
                var canvas = this.key_to_canvas[key];
                if(canvas){
                	cm.free_canvas(canvas);
            	}
                delete this.key_to_canvas[key];
                delete this.key_to_rendered_options[key];
            }
        },
        _groups_set: function(new_val, old_val){
            var removed = this.groups_collection ? 
                            this.groups_collection.getKeys() : []; 
            this.groups_collection = Array.isArray(new_val) && Polymer.Collection.get(new_val);
            var added = this.groups_collection ? 
                            this.groups_collection.getKeys() : []; 
            this._update_keys(removed, added);
        },
        _groups_spliced: function(splices){
        	if(!splices) return;
            var dedupes = Utils.dedupe(splices.keySplices);
            this._update_keys(dedupes.removed, dedupes.added);
        }
	});
</script>

  
</dom-module>